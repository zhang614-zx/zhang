# 高概率结节和恶性肿瘤详细数据展示功能

## 功能概述

本次更新为医学影像AI辅助诊断系统增加了高概率结节和恶性肿瘤的详细数据展示功能，包括：

1. **高概率结节和恶性肿瘤的详细数据**
   - 结节概率和恶性概率
   - 切片位置（体素坐标）
   - 物理坐标（毫米）
   - 状态分类（高概率恶性/高概率良性/恶性肿瘤）

2. **标记高概率结节和恶性肿瘤位置的CT灰度图**
   - 在分割可视化图上标记结节位置
   - 用不同颜色和标记区分高概率结节和恶性肿瘤
   - 显示概率数值标签

## 筛选逻辑

系统只显示以下类型的结节：
- **高概率结节**：结节概率 ≥ 0.5
- **恶性肿瘤**：恶性概率 ≥ 0.5（即使结节概率较低）

低概率结节（结节概率 < 0.5 且 恶性概率 < 0.5）将被过滤掉，不显示在详细数据表格中。

## 后端实现

### 1. 详细数据生成 (`model.py`)

在 `predict_all` 函数中，为每个检测到的结节增加了详细坐标信息：

```python
nodule_results.append({
    "prob_nodule": prob_nodule,           # 结节概率
    "prob_malignant": prob_malignant,     # 恶性概率
    "center_irc": [z, y, x],              # 体素坐标
    "center_xyz": [x_mm, y_mm, z_mm]     # 物理坐标(mm)
})
```

### 2. 可视化增强

在生成CT切片可视化时，增加了结节标记功能：

- **红色 X 标记**：高概率恶性肿瘤
- **黄色圆圈**：高概率良性结节
- **概率标签**：显示结节概率和恶性概率
- **图例说明**：区分不同类型的结节

## 前端实现

### 1. 预测页面 (`predict.html`)

在预测结果展示区域增加了高概率结节和恶性肿瘤详细数据表格：

| 编号 | 结节概率 | 恶性概率 | 切片位置 | 体素坐标 | 物理坐标(mm) | 状态 |
|------|----------|----------|----------|----------|--------------|------|
| 1    | 87.5%    | 92.3%    | 80       | [80,256,256] | [-100.2,50.3,-200.1] | 高概率恶性 |
| 2    | 65.2%    | 23.1%    | 75       | [75,245,267] | [-98.5,48.7,-195.2] | 高概率良性 |
| 3    | 23.1%    | 78.9%    | 82       | [82,234,289] | [-102.1,52.1,-205.3] | 恶性肿瘤 |

### 2. 历史记录页面 (`history.html`)

在历史记录详情展示中也增加了相同的详细数据表格，支持查看历史病例的详细结节信息。

### 3. 统计页面 (`stats.html`)

在个人病例分析部分增加了简化的详细结节数据表格，显示关键信息。

## 数据格式

### 结节数据格式

```json
{
  "nodule_results": [
    {
      "prob_nodule": 0.875,
      "prob_malignant": 0.923,
      "center_irc": [80, 256, 256],
      "center_xyz": [-100.2, 50.3, -200.1]
    }
  ],
  "nodule_summary": {
    "total": 5,
    "high_prob_nodule_count": 3,
    "threshold": 0.5,
    "max_prob_nodule": 0.923,
    "min_prob_nodule": 0.234,
    "avg_prob_nodule": 0.678
  },
  "malignancy_summary": {
    "恶性肿瘤数": 2,
    "良性肿瘤数": 3,
    "threshold": 0.5,
    "max_prob_malignant": 0.923,
    "min_prob_malignant": 0.123,
    "avg_prob_malignant": 0.456
  }
}
```

### 可视化文件

生成的CT切片可视化文件包含：
- 原始CT灰度图像
- 肺部分割mask（红色半透明）
- 结节位置标记（红色X/黄色圆圈）
- 概率数值标签
- 切片编号信息

## 使用方法

### 1. 上传CT文件并分析

1. 访问 `/predict` 页面
2. 填写患者基本信息
3. 上传CT影像文件（.mhd + .raw）
4. 点击"分析"按钮
5. 等待分析完成

### 2. 查看详细结果

分析完成后，页面会显示：
- **基本统计信息**：总结节数、高概率结节数、恶性肿瘤数
- **详细结节数据表格**：每个结节的详细信息和坐标
- **可视化图像**：标记了结节位置的CT切片
- **AI诊断建议**：基于分析结果的医学建议

### 3. 查看历史记录

1. 访问 `/history` 页面
2. 点击"查看"按钮查看历史病例
3. 在详情页面查看完整的结节数据

## 技术特点

### 1. 坐标系统

- **体素坐标 (center_irc)**：图像坐标系，用于定位切片位置
- **物理坐标 (center_xyz)**：世界坐标系，用于医学定位

### 2. 概率阈值

- **结节概率阈值**：0.5（默认）
- **恶性概率阈值**：0.5（默认）
- 可在后端配置中调整

### 3. 状态分类

- **高概率恶性**：结节概率 ≥ 0.5 且 恶性概率 ≥ 0.5
- **高概率良性**：结节概率 ≥ 0.5 且 恶性概率 < 0.5
- **恶性肿瘤**：结节概率 < 0.5 但 恶性概率 ≥ 0.5
- **低概率结节**：结节概率 < 0.5 且 恶性概率 < 0.5（不显示）

## 测试验证

运行测试脚本验证功能：

```bash
python test_detailed_results.py
```

该脚本会：
1. 自动查找测试用的CT文件
2. 调用预测函数生成详细数据
3. 输出详细的结节信息和坐标
4. 验证可视化文件生成

## 注意事项

1. **文件格式**：支持.mhd/.raw格式的CT文件
2. **坐标精度**：物理坐标保留1位小数
3. **概率显示**：前端显示为百分比格式
4. **切片编号**：从1开始计数（体素坐标+1）
5. **错误处理**：坐标信息缺失时显示"未知"

## 后续扩展

1. **3D可视化**：集成vtk.js实现3D结节标注
2. **测量功能**：计算结节大小、体积等
3. **报告生成**：自动生成PDF诊断报告
4. **数据导出**：支持导出详细数据为Excel/CSV
5. **批量处理**：支持多个病例的批量分析 